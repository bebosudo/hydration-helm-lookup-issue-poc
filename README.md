# PoC repo to reproduce hydration issue with kustomize helmCharts and a chart using lookup to get secret data

## Steps to reproduce:

1. Create a namespace

```bash
$ kubectl create ns hydration-test
```

2. Create a secret in that namespace

```bash
$ kubectl -n hydration-test create secret generic my-secret --from-literal=the-password=mysecret
```

3. Test that installing the chart with helm works as expected

```bash
$ helm --namespace hydration-test install hydration-release charts/hydration-test/
```

4. Check that the secret data is correctly retrieved

```bash
$ kubectl -n hydration-test get secret/hydration-release-hydration-test -o json |jq ".data | map_values(@base64d)"
{
  "hydration-secret-key": "mysecret"
}
```

5. Now delete the release installed with helm and try to use kustomize to install the same helm
   chart

```bash
$ helm --namespace hydration-test uninstall hydration-release
$ kustomize build --enable-helm |k -n hydration-test apply -f -
secret/hydration-release-hydration-test created
```

6. Check the secret data again

```bash
$ kubectl -n hydration-test get secret/hydration-release-hydration-test -o json |jq ".data | map_values(@base64d)"
{
  "hydration-secret-key": "xhjX58V5pa"
}
```

Note that the secret data is randomly generated by Helm, because `kustomize` doesn't interact with
the cluster to retrieve existing secret data using `lookup` as `helm` does.

This is particularly relevant when using lookup functions to retrieve sensitive data and create a
"duplicate" entry in a secret managed by the chart, e.g. by using Bitnami's common chart function
[`common.secrets.passwords.manage`](https://github.com/bitnami/charts/blob/b1afd5e96c71bbf2fa5ee10d23ca0d7d958fe3a9/bitnami/common/templates/_secrets.tpl#L66).
Make sure to wrap the use of such functions in conditionals checking whether the user provided a
secret value and mount that value directly on the deployments/statefulsets using `secretKeyRef`.
